<%- include("../../views/partials/user/header") %>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
rel="stylesheet">

<!-- Css Styles -->
<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
<link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
<link rel="stylesheet" href="css/nice-select.css" type="text/css">
<link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
<link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
<link rel="stylesheet" href="css/style.css" type="text/css">

<!-- Custom CSS for checkbox alignment -->
<style>
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            border-radius: 2px;
            margin-right: 10px;
            position: relative;
            top: 0;
            background-color: white;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"]:checked {
            background-color: #000;
            border-color: #000;
        }
        
        .checkbox-container input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .nice-scroll {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .shop__sidebar__categories ul,
        .shop__sidebar__brand ul,
        .shop__sidebar__price ul {
            padding-left: 5px;
            margin-top: 10px;
        }
        
        .shop__sidebar__categories li,
        .shop__sidebar__brand li,
        .shop__sidebar__price li {
            list-style: none;
        }
        
        .shop__sidebar__filter__btn {
            display: none;
        }
        
        .filter-loading {
            display: none;
            text-align: center;
            padding: 10px 0;
        }
        
        .filter-loading i {
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-heading a {
            font-weight: 600;
            font-size: 16px;
            color: #111;
            display: block;
            padding: 10px 0;
            text-decoration: none;
        }
        
        .card {
            border: none;
            margin-bottom: 15px;
        }
        
        .card-body {
            padding: 0 0 15px 0;
        }

        .wishlist-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            margin-right: 5px;
            background-color: white;
            padding: 5px;
            border-radius: 50%;
            color: #0f0e0e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            z-index: 10;
            transition: 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Filter Button */
        .mobile-filter-btn {
            display: none;
            background: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-filter-btn:hover {
            background: #333;
        }

        .mobile-filter-btn i {
            margin-right: 8px;
        }

        /* Desktop styles (default) - sidebar stays in column */
        @media (min-width: 992px) {
            .shop__sidebar__search {
                position: static;
                transform: none;
                box-shadow: none;
                z-index: auto;
                width: 100%;
                height: auto;
                overflow-y: visible;
                background: transparent;
            }
        }

        /* Mobile and Tablet styles - sidebar becomes slide-out panel */
        @media (max-width: 991.98px) {
            .mobile-filter-btn {
                display: inline-block;
            }

            .shop__sidebar__search {
                position: fixed;
                top: 0;
                left: -100%;
                width: 320px;
                max-width: 85vw;
                height: 100vh;
                background: white;
                z-index: 1050;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
                padding: 20px;
                transition: left 0.3s ease;
            }

            .shop__sidebar__search.active {
                left: 0;
            }

            /* Close button for mobile */
            .mobile-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                color: #666;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .mobile-close-btn:hover {
                background: #f5f5f5;
                color: #000;
            }

            /* Mobile sidebar header */
            .mobile-sidebar-header {
                padding-top: 50px;
                margin-bottom: 20px;
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
            }

            .mobile-sidebar-header h5 {
                margin: 0;
                font-weight: 600;
                color: #333;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Prevent body scrolling when sidebar is open */
        body.overflow-hidden {
            overflow: hidden;
        }

        /* Demo styles for layout demonstration */
        .demo-products {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            min-height: 500px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Fix container margins and padding to remove white space */
        .shop .container {
            max-width: 100% !important;
            padding-left: 15px !important;
            padding-right: 15px !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }

        /* Ensure full width on larger screens */
        @media (min-width: 1200px) {
            .shop .container {
                max-width: 1200px !important;
            }
        }

        @media (min-width: 992px) and (max-width: 1199px) {
            .shop .container {
                max-width: 960px !important;
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            .shop .container {
                max-width: 720px !important;
            }
        }

        @media (max-width: 767px) {
            .shop .container {
                max-width: 100% !important;
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
        }
    </style>

<!-- Shop Section Begin -->
<section class="shop spad">
  <div class="container">
      <div class="row">
          <div class="col-lg-3">
                <!-- Mobile Filter Button (only shows on small screens) -->
                <button class="mobile-filter-btn" id="mobileFilterBtn">
                    <i class="fas fa-filter"></i>
                    Filters
                </button>

                <!-- Filter Sidebar -->
                <div class="shop__sidebar__search" id="filterSidebar">
                    <!-- Mobile Close Button (only shows on small screens) -->
                    <button class="mobile-close-btn d-lg-none" id="closeSidebarBtn">
                        <i class="fas fa-times"></i>
                    </button>

                    <!-- Mobile Sidebar Header (only shows on small screens) -->
                    <div class="mobile-sidebar-header d-lg-none">
                        <h5>Filter Products</h5>
                    </div>

                    <!-- Single form for all filters -->
                    <form id="filterForm">
                        <!-- Sort option moved to top -->
                        <div class="shop__product__option mb-3">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="shop__product__option__right">
                                        <select id="sortSelect" name="sort">
                                            <option value="">Sort By Price or Name</option>
                                            <option value="ascending">Price: Low To High</option>  
                                            <option value="descending">Price: High To Low</option>
                                            <option value="name_asc"> Name: aA - zZ </option>
                                            <option value="name_dsc"> Name: zZ - aA</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="shop__sidebar">
                            <!-- Search input -->
                            <div class="mb-2">                 
                                <input type="text" id="searchInput" name="query" placeholder="Search...">
                                <button type="button" id="searchBtn"><span class="icon_search"></span></button>
                            </div>
                            
                            <div class="shop__sidebar__accordion">
                                <div class="accordion" id="accordionExample">  
                                    <!-- Categories -->
                                    <div class="card">
                                        <div class="card-heading">
                                            <a data-toggle="collapse" data-target="#collapseOne">CATEGORIES</a>
                                        </div>
                                        <div id="collapseOne" class="collapse show" data-parent="#accordionExample">
                                            <div class="card-body">
                                                <div class="shop__sidebar__categories">
                                                    <ul class="nice-scroll">
                                                        <% for(let i=0; i<category.length; i++) { %>
                                                            <li>
                                                                <label class="checkbox-container">
                                                                    <input type="checkbox" class="auto-filter" name="category" value="<%= category[i]._id %>">
                                                                    <%= category[i].name %>
                                                                </label>
                                                            </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Brands -->
                                    <div class="card">
                                        <div class="card-heading">
                                            <a data-toggle="collapse" data-target="#collapseTwo">BRANDING</a>
                                        </div>
                                        <div id="collapseTwo" class="collapse show" data-parent="#accordionExample">
                                            <div class="card-body">
                                                <div class="shop__sidebar__brand">
                                                    <ul>
                                                        <% for(let i=0; i<brand.length; i++) { %>
                                                            <li>
                                                                <label class="checkbox-container">
                                                                    <input type="checkbox" class="auto-filter" name="brand" value="<%= brand[i]._id %>">
                                                                    <%= brand[i].brandName %>
                                                                </label>
                                                            </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price Filter -->
                                    <div class="card">
                                        <div class="card-heading">
                                            <a data-toggle="collapse" data-target="#collapseThree">FILTER PRICE</a>
                                        </div>
                                        <div id="collapseThree" class="collapse show" data-parent="#accordionExample">
                                            <div class="card-body">
                                                <div class="shop__sidebar__price">
                                                    <ul>
                                                        <li>
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" class="auto-filter" name="price" value="0-500">
                                                                ₹0.00 - ₹500.00
                                                            </label>
                                                        </li>
                                                        <li>
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" class="auto-filter" name="price" value="500-1000">
                                                                ₹500.00 - ₹1000.00
                                                            </label>
                                                        </li>
                                                        <li>
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" class="auto-filter" name="price" value="1000-1500">
                                                                ₹1000.00 - ₹1500.00
                                                            </label>
                                                        </li>
                                                        <li>
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" class="auto-filter" name="price" value="1500-100000">
                                                                ₹1500.00+
                                                            </label>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>    
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Loading indicator -->
                    <div class="filter-loading" id="loadingIndicator">
                        <i class="fa fa-spinner"></i> Loading...
                    </div>
                </div>
            </div>
          
          <div class="col-lg-9">
              <div class="row" id="products-container">
                  <% for(let i=0; i<products.length; i++) { %>
                      <div class="col-6 col-sm-6 col-md-6 col-lg-4">                       
                          <div class="product__item">
                            <a href="/productDetails?id=<%= products[i]._id %>">
                              <div class="product__item__pic set-bg" data-setbg="<%= products[i].productImages[0] %>">
                              </div>
                            </a>
                            <a href="/addToWishlist?id=<%= products[i]._id %>" class="wishlist-btn" title="Add to Wishlist">
                                    <i class="fas fa-heart"></i>
                            </a>
<div class="text-center">
  <!-- Sale price and Regular price in one line -->
  <div class="d-flex justify-content-center align-items-center gap-2 mb-1 flex-wrap">
    <h5 class="text-dark fw-bold m-0">₹<%= products[i].salePrice.toLocaleString('en-IN') %></h5>
    <span class="text-muted text-decoration-line-through small">
      ₹<%= products[i].regularPrice.toLocaleString('en-IN') %>
    </span>
  </div>

  <!-- Product name and brand in one line -->
  <div class="d-flex justify-content-center align-items-center flex-wrap gap-1 mb-1">
    <h6 class="text-dark fw-semibold m-0"><%= products[i].productName %></h6>
    <span class="small text-muted">| <%= products[i].brand %></span>
  </div>
  <p class="text-secondary small m-0">
    <%= products[i].description.length > 15 ? products[i].description.slice(0, 30) + '...' : products[i].description %>
  </p>
</div>
                          </div>
                      </div>
                  <% } %>
              </div>
              <div class="row">
                  <div class="col-lg-12">
                      <div class="product__pagination" id="pagination-container">
                          <% if (currentPage > 1) { %>
                              <a href="/shop?page=<%= currentPage - 1 %>"><</a>
                          <% } %>
                          <% for (let i = 1; i <= totalPages; i++) { %>
                              <% if (currentPage === i) { %>
                                  <a class="active" href="/shop?page=<%= i %>"><%= i %></a>
                              <% } else { %>
                                  <a href="/shop?page=<%= i %>"><%= i %></a>
                              <% } %>
                          <% } %>
                          <% if (currentPage < totalPages) { %>
                              <a href="/shop?page=<%= currentPage + 1 %>">></a>
                          <% } %>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</section>

<script>
// Unified function to handle all filtering
function applyFilters() {
    const form = document.getElementById("filterForm");
    const formData = new FormData(form);
    
    // Show loading indicator
    document.getElementById("loadingIndicator").style.display = 'block';
    
    // Collect form data in the same structure as your original form
    const filterData = {};
    
    // Add search query
    const searchQuery = document.getElementById("searchInput").value.trim();
    if (searchQuery) {
        filterData.query = searchQuery;
    }
    
    // Add sort option
    const sortValue = document.getElementById("sortSelect").value;
    if (sortValue) {
        filterData.sort = sortValue;
    }
    
    // Collect checked checkboxes (same as your original logic)
    for (let [key, value] of formData.entries()) {
        if (key !== 'query' && key !== 'sort') { // Skip search and sort as we handled them above
            if (!filterData[key]) {
                filterData[key] = [];
            }
            filterData[key].push(value);
        }
    }
    
    console.log("Sending filter data:", filterData);
    
    // Send to backend
    fetch('/filterSearchSort', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(filterData)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Response from backend:", data);
        
        // Hide loading indicator
        document.getElementById("loadingIndicator").style.display = 'none';
        
        const products = data.data;
        const productsContainer = document.getElementById("products-container");
        
        // Clear previous products
        productsContainer.innerHTML = "";
        
        // Handle empty case
        if (!products || products.length === 0) {
            productsContainer.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-5">
                        <h4>No products found</h4>
                        <p>Try adjusting your filters or search query</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Render new products
        products.forEach(product => {
            const productHTML = `
                <div class="col-6 col-sm-6 col-md-6 col-lg-4">                       
                    <div class="product__item">
                        <a href="/productDetails?id=${product._id}">
                            <div class="product__item__pic set-bg" data-setbg="${product.productImages[0]}">
                            </div>
                        </a>
                        <a href="/addToWishlist?id=${product._id}" class="wishlist-btn" title="Add to Wishlist">
                                    <i class="fas fa-heart"></i>
                            </a>
                        <div class="text-center">
                            <!-- Sale price and Regular price in one line -->
                            <div class="d-flex justify-content-center align-items-center gap-2 mb-1 flex-wrap">
                                <h5 class="text-dark fw-bold m-0">₹${product.salePrice.toLocaleString('en-IN')}</h5>
                                <span class="text-muted text-decoration-line-through small">
                                    ₹${product.regularPrice.toLocaleString('en-IN')}
                                    </span>
                                    </div>
                                    <!-- Product name and brand in one line -->
                                    <div class="d-flex justify-content-center align-items-center flex-wrap gap-1 mb-1">
                                        <h6 class="text-dark fw-semibold m-0">${product.productName}</h6>
                                        <span class="small text-muted">| ${product.brand}</span>
                                        </div>
                                        <!-- Description -->
                                        <p class="text-secondary small m-0">
    ${product.description.length > 30 ? product.description.slice(0, 30) + '...' : product.description}
  </p>
</div>
                    </div>
                </div>
            `;
            productsContainer.insertAdjacentHTML('beforeend', productHTML);
        });
        
        // Apply background images
        document.querySelectorAll('.set-bg').forEach(el => {
            const bg = el.getAttribute('data-setbg');
            if (bg) {
                el.style.backgroundImage = `url(${bg})`;
            }
        });

        // Reinitialize wishlist buttons for new products
        if (window.reinitializeWishlistButtons) {
            window.reinitializeWishlistButtons();
        }

        // Update pagination if provided
        if (data.pagination) {
            updatePagination(data.pagination);
        }
    })
    .catch(error => {
        console.error("Error sending data:", error);
        document.getElementById("loadingIndicator").style.display = 'none';
        
        // Show error message
        document.getElementById("products-container").innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <h4>Error loading products</h4>
                    <p>Please try again later</p>
                </div>
            </div>
        `;
    });
}

// Debounce function to avoid too many API calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Create debounced version of applyFilters
const debouncedApplyFilters = debounce(applyFilters, 300);

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Checkbox change events
    document.querySelectorAll(".auto-filter").forEach(function (checkbox) {
        checkbox.addEventListener("change", applyFilters);
    });
    
    // Sort dropdown change
    document.getElementById("sortSelect").addEventListener("change", applyFilters);
    
    // Search input (with debounce)
    document.getElementById("searchInput").addEventListener("input", debouncedApplyFilters);
    
    // Search button click
    document.getElementById("searchBtn").addEventListener("click", function(e) {
        e.preventDefault();
        applyFilters();
    });
    
    // Enter key in search input
    document.getElementById("searchInput").addEventListener("keypress", function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
});

// Function to update pagination (optional)
function updatePagination(paginationData) {
    const paginationContainer = document.getElementById("pagination-container");
    if (!paginationContainer || !paginationData) return;
    
    let paginationHTML = '';
    
    if (paginationData.currentPage > 1) {
        paginationHTML += `<a href="#" onclick="loadPage(${paginationData.currentPage - 1})"><</a>`;
    }
    
    for (let i = 1; i <= paginationData.totalPages; i++) {
        if (paginationData.currentPage === i) {
            paginationHTML += `<a class="active" href="#" onclick="loadPage(${i})">${i}</a>`;
        } else {
            paginationHTML += `<a href="#" onclick="loadPage(${i})">${i}</a>`;
        }
    }
    
    if (paginationData.currentPage < paginationData.totalPages) {
        paginationHTML += `<a href="#" onclick="loadPage(${paginationData.currentPage + 1})">></a>`;
    }
    
    paginationContainer.innerHTML = paginationHTML;
}

// Function to load specific page (optional)
function loadPage(page) {
    // You can modify this to include page in your filter request
    console.log("Loading page:", page);
    // applyFilters(); // You might want to modify applyFilters to accept page parameter
}
document.addEventListener('DOMContentLoaded', function() {
            const filterSidebar = document.getElementById('filterSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mobileFilterBtn = document.getElementById('mobileFilterBtn');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');

            // Open sidebar on mobile
            mobileFilterBtn.addEventListener('click', function() {
                filterSidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.classList.add('overflow-hidden');
            });

            // Close sidebar function
            function closeSidebar() {
                filterSidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.classList.remove('overflow-hidden');
            }

            // Close sidebar when close button is clicked
            closeSidebarBtn.addEventListener('click', closeSidebar);

            // Close sidebar when overlay is clicked
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Close sidebar on window resize if screen becomes large
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992) {
                    closeSidebar();
                }
            });
        });
</script>

<%- include("../../views/partials/user/footer") %>